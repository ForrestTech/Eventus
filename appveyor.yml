version: 0.1.{build}-alpha
pull_requests:
  do_not_increment_build_number: true
skip_branch_with_pr: true
image: Visual Studio 2017
services:
  - mssql2016
nuget:
  disable_publish_on_pr: true
build_script:
# Run full build, unit tests, sql integration tests and nuget package 
- ps: .\build.ps1 -target CI-Sql-Test -ScriptArgs '-package-version="$env:appveyor_build_version"'
after_test:
# generate coverage report for Xunit
- ps: src\packages\OpenCover.4.6.519\tools\OpenCover.Console.exe -register:user -filter:"+[Eventus]* -[Eventus]Eventus.Logging.* -[Eventus]Eventus.LibLog.*" -target:"src\packages\xunit.runner.console.2.2.0\tools\xunit.console.exe" -targetargs:"src\Eventus.Tests.Unit\bin\$env:CONFIGURATION\Eventus.Tests.Unit.dll -noshadow" -output:coverage.xml
# push coverage to coverall
- ps: src\packages\coveralls.io.1.3.4\tools\coveralls.net.exe --opencover coverage.xml
test: off
artifacts:
- path: Eventus.*.nupkg
deploy:
- provider: NuGet
  server: https://www.nuget.org/api/v2/package
  api_key:
    secure: IjuS8PTdvnV6jLVruUFHFCaOpk4HSH05V5k0D0TRTZRON4Gt9IKK+im3NAjuWs7h
  on:
    branch: master
environment:
    COVERALLS_REPO_TOKEN:  
       secure: Xr+EYSpLkGI6fLy4uPdGuI5nVZRcqUZakaswMMn2kkZ5iyFI/p6pHQ5dOJ3hlY4N